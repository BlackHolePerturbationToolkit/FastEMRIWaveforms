

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fast self-forced trajectories &mdash; few: Fast EMRI Waveforms 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Fast and Accurate EMRI Waveforms Tutorial" href="FastEMRIWaveforms_tutorial.html" />
    <link rel="prev" title="Citations" href="../user/cite.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: coral" >

          
          
          <a href="../index.html" class="icon icon-home">
            few: Fast EMRI Waveforms
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/main.html">Overall Waveform Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/traj.html">Trajectory Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/amp.html">Amplitude Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/sum.html">Summation Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/util.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/cite.html">Citations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fast self-forced trajectories</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ODE-classes">ODE classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Parameter-conventions">Parameter conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Stock-trajectory-models">Stock trajectory models</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Obtaining-the-right-hand-side-of-the-trajectory-ODE">Obtaining the right-hand side of the trajectory ODE</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Checking-the-properties-of-an-ODE-system">Checking the properties of an ODE system</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Trajectory-evaluation">Trajectory evaluation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#The-EMRIInspiral-class">The EMRIInspiral class</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Trajectory-stopping-conditions">Trajectory stopping conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Output-on-a-requested-time-grid">Output on a requested time grid</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Return-trajectory-in-dimensionless-time-coordinates">Return trajectory in dimensionless time coordinates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Integrating-trajectories-with-a-fixed-time-step">Integrating trajectories with a fixed time-step</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Evolving-trajectories-backwards-in-time">Evolving trajectories backwards in time</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Setting-the-integrator-error-tolerance">Setting the integrator error tolerance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Integrating-trajectories-in-(E,-L,-Q)-coordinates">Integrating trajectories in <span class="math notranslate nohighlight">\((E, L, Q)\)</span> coordinates</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#User-defined-trajectory-models">User-defined trajectory models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Modifying-an-existing-trajectory-model">Modifying an existing trajectory model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Passing-additional-arguments-to-a-modified-trajectory-model">Passing additional arguments to a modified trajectory model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Trajectory-related-utilities">Trajectory-related utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Get-p_0-based-on-desired-duration-of-trajectory">Get <span class="math notranslate nohighlight">\(p_0\)</span> based on desired duration of trajectory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Get-\mu-based-on-desired-duration-of-trajectory">Get <span class="math notranslate nohighlight">\(\mu\)</span> based on desired duration of trajectory</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html">Fast and Accurate EMRI Waveforms Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Full-EMRI-Waveforms-in-Schwarzschild-Eccentric">Full EMRI Waveforms in Schwarzschild Eccentric</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Trajectory-Module">Trajectory Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Amplitude-Module">Amplitude Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Spin-weighted-spherical-harmonics">Spin-weighted spherical harmonics</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Mode-Selection">Mode Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Parallelized-Cubic-Spline-Interpolation">Parallelized Cubic Spline Interpolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Mode-Summation">Mode Summation</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Utility-functions">Utility functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Creating-modules">Creating modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Augmented-Analytic-Kludge-with-5PN-trajectory">Augmented Analytic Kludge with 5PN trajectory</a></li>
<li class="toctree-l1"><a class="reference internal" href="FastEMRIWaveforms_tutorial.html#Citing-waveforms-and-modules">Citing waveforms and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorial_FD_construction_single_mode.html">Single Mode Frequency Domain Waveform Construction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorial_FrequencyDomain_Waveforms.html">EMRI Waveforms in frequency domain</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">General Information:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../general/docs_main.html">FastEMRIWaveforms Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/docs_main.html#package-todos">Package TODOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/docs_main.html#change-log">Change Log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: coral" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">few: Fast EMRI Waveforms</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Fast self-forced trajectories</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorial/Trajectory_tutorial.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="../user/cite.html" class="btn btn-neutral float-left" title="Citations" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="FastEMRIWaveforms_tutorial.html" class="btn btn-neutral float-right" title="Fast and Accurate EMRI Waveforms Tutorial" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Fast-self-forced-trajectories">
<h1>Fast self-forced trajectories<a class="headerlink" href="#Fast-self-forced-trajectories" title="Link to this heading"></a></h1>
<p>An essential component of the FastEMRIWaveforms (FEW) framework is the rapid evaluation of the inspiral trajectory of the secondary compact object. FEW provides the tools required for users to generate and visualiase these trajectories. Users can also implement their own trajectory models to incorporate additional physics (such as environmental effects or modifications to gravity). We will demonstrate these capabilities in this tutorial.</p>
<section id="ODE-classes">
<h2>ODE classes<a class="headerlink" href="#ODE-classes" title="Link to this heading"></a></h2>
<section id="Parameter-conventions">
<h3>Parameter conventions<a class="headerlink" href="#Parameter-conventions" title="Link to this heading"></a></h3>
<p>FEW constructs trajectories by integrating the equations of motion of the compact binary; these are a system of ordinary differential equations (ODEs) that describe the evolution of the following parameters:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Definition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(p\)</span></p></td>
<td><p>(Dimensionless) semi-latus rectum</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(e\)</span></p></td>
<td><p>Eccentricity</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(x_I\)</span></p></td>
<td><p>Cosine of the inclination of the orbital plane</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\Phi_\phi\)</span></p></td>
<td><p>Azimuthal GW phase</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(\Phi_\theta\)</span></p></td>
<td><p>Polar GW phase</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\Phi_r\)</span></p></td>
<td><p>Radial GW phase</p></td>
</tr>
</tbody>
</table>
<p>The ODE system can be integrated efficiently with adaptive Runge-Kutta techniques. These solvers obtain trajectories by integrating the right-hand side (RHS) of the ODE with respect to a time parameter.</p>
</section>
<section id="Stock-trajectory-models">
<h3>Stock trajectory models<a class="headerlink" href="#Stock-trajectory-models" title="Link to this heading"></a></h3>
<p>In order to handle the necessary information for evaluating the RHS of the ODE, FEW defines ODE classes. The following stock options are available:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Model</p></th>
<th class="head"><p>Features</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>KerrEqEccFlux</p></td>
<td><p>Adiabatic; equatorial eccentric inspiral with spinning primary</p></td>
<td><p>Our most up-to-date model</p></td>
</tr>
<tr class="row-odd"><td><p>SchwarzEccFlux</p></td>
<td><p>Adiabatic; inspiral with non-spinning primary</p></td>
<td><p>An older model (currently outdated)</p></td>
</tr>
<tr class="row-even"><td><p>PN5</p></td>
<td><p>Post-Newtonian; eccentric inclined inspirals with spinning primary</p></td>
<td><p>Most complete model, but inaccurate for larger <span class="math notranslate nohighlight">\(e\)</span> and/or lower <span class="math notranslate nohighlight">\(p\)</span></p></td>
</tr>
</tbody>
</table>
</section>
<section id="Obtaining-the-right-hand-side-of-the-trajectory-ODE">
<h3>Obtaining the right-hand side of the trajectory ODE<a class="headerlink" href="#Obtaining-the-right-hand-side-of-the-trajectory-ODE" title="Link to this heading"></a></h3>
<p>As an example, let’s examine the SchwarzEccFlux model:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">few.trajectory.ode</span> <span class="kn">import</span> <span class="n">SchwarzEccFlux</span>
<span class="n">rhs</span> <span class="o">=</span> <span class="n">SchwarzEccFlux</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Before evaluating the RHS, we must first define the parameters of the system that remain fixed during an inspiral. At adiabatic order, these are the component masses (<span class="math notranslate nohighlight">\(M\)</span> and <span class="math notranslate nohighlight">\(\mu\)</span>) and the dimensionless spin parameter of the primary (<span class="math notranslate nohighlight">\(a\)</span>):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="mf">1e6</span>  <span class="c1"># Solar masses</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">1e1</span>  <span class="c1"># Solar masses</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># For a Schwarzschild inspiral, the spin parameter is zero</span>

<span class="n">rhs</span><span class="o">.</span><span class="n">add_fixed_parameters</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can then access the ODE derivatives:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">e</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">x</span> <span class="o">=</span> <span class="mf">1.</span>  <span class="c1"># Schwarzschild inspiral is equatorial by definition</span>

<span class="n">pdot</span><span class="p">,</span> <span class="n">edot</span><span class="p">,</span> <span class="n">xIdot</span><span class="p">,</span> <span class="n">Omega_phi</span><span class="p">,</span> <span class="n">Omega_theta</span><span class="p">,</span> <span class="n">Omega_r</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">])</span>
<span class="n">pdot</span><span class="p">,</span> <span class="n">edot</span><span class="p">,</span> <span class="n">xIdot</span><span class="p">,</span> <span class="n">Omega_phi</span><span class="p">,</span> <span class="n">Omega_theta</span><span class="p">,</span> <span class="n">Omega_r</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(np.float64(-0.017771723696175704),
 np.float64(-0.0007792815003978554),
 np.float64(0.0),
 np.float64(0.028647063536752972),
 np.float64(0.028647063536752972),
 np.float64(0.018040932375307846))
</pre></div></div>
</div>
<p>FEW integrates trajectories on the radiation-reaction timescale <span class="math notranslate nohighlight">\(t_\mathrm{rr} = t \epsilon\)</span>, where <span class="math notranslate nohighlight">\(\epsilon = \mu / M\)</span> is the mass ratio of the system. The RHS of the ODE is therefore defined such that the <span class="math notranslate nohighlight">\((\dot{p}, \dot{e}, \dot{x}_I)\)</span> are scaled by <span class="math notranslate nohighlight">\(\epsilon^{-1}\)</span>. We can easily undo this rescaling if required:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pdot</span><span class="p">,</span> <span class="n">edot</span><span class="p">,</span> <span class="n">xIdot</span><span class="p">,</span> <span class="n">Omega_phi</span><span class="p">,</span> <span class="n">Omega_theta</span><span class="p">,</span> <span class="n">Omega_r</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">scale_by_eps</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pdot</span><span class="p">,</span> <span class="n">edot</span><span class="p">,</span> <span class="n">xIdot</span><span class="p">,</span> <span class="n">Omega_phi</span><span class="p">,</span> <span class="n">Omega_theta</span><span class="p">,</span> <span class="n">Omega_r</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(np.float64(-1.7771723696175706e-07),
 np.float64(-7.792815003978555e-09),
 np.float64(0.0),
 np.float64(0.028647063536752972),
 np.float64(0.028647063536752972),
 np.float64(0.018040932375307846))
</pre></div></div>
</div>
</section>
<section id="Checking-the-properties-of-an-ODE-system">
<h3>Checking the properties of an ODE system<a class="headerlink" href="#Checking-the-properties-of-an-ODE-system" title="Link to this heading"></a></h3>
<p>The ODE class also defines a number of properties that describe the physical and systematic assumptions of the model:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">few.trajectory.ode.base</span> <span class="kn">import</span> <span class="n">get_ode_properties</span>
<span class="n">get_ode_properties</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;convert_Y&#39;: False,
 &#39;equatorial&#39;: True,
 &#39;circular&#39;: False,
 &#39;supports_ELQ&#39;: True,
 &#39;background&#39;: &#39;Schwarzschild&#39;,
 &#39;separatrix_buffer_dist&#39;: 0.1,
 &#39;nparams&#39;: 6}
</pre></div></div>
</div>
</section>
</section>
<section id="Trajectory-evaluation">
<h2>Trajectory evaluation<a class="headerlink" href="#Trajectory-evaluation" title="Link to this heading"></a></h2>
<section id="The-EMRIInspiral-class">
<h3>The EMRIInspiral class<a class="headerlink" href="#The-EMRIInspiral-class" title="Link to this heading"></a></h3>
<p>Trajectories are evaluated using the <code class="docutils literal notranslate"><span class="pre">EMRIInspiral</span></code> class, which interfaces with the underlying integrator classes and methods in order to integrate the trajectory from its initial conditions until either the maximum alloted duration elapses or pre-determined stopping conditions are satisfied.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">EMRIInspiral</span></code> class offers a number of features that can be adjusted according to the desired output. We will demonstrate these below, working with the <code class="docutils literal notranslate"><span class="pre">KerrEccEqFlux</span></code> trajectory model as an example.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">few.trajectory.inspiral</span> <span class="kn">import</span> <span class="n">EMRIInspiral</span>
<span class="kn">from</span> <span class="nn">few.trajectory.ode</span> <span class="kn">import</span> <span class="n">KerrEccEqFlux</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># You can also instantiate this as EMRIInspiral(func=&quot;KerrEccEqFlux&quot;) to save an import.</span>
<span class="n">traj_model</span> <span class="o">=</span> <span class="n">EMRIInspiral</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">KerrEccEqFlux</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="mf">1e6</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">1e2</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">0.9</span>  <span class="c1"># This model supports a spinning primary compact object</span>
<span class="n">p0</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">e0</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">xI0</span> <span class="o">=</span> <span class="mf">1.</span>  <span class="c1"># +1 for prograde, -1 for retrograde inspirals</span>

<span class="n">T</span> <span class="o">=</span> <span class="mf">4.</span>  <span class="c1"># duration of trajectory in years (as defined by few.utils.constants.YRSID_SI)</span>

<span class="n">traj_pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">xI0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">xI</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$e$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$p$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$e$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\Phi_\phi$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\Phi_\theta$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\Phi_r$&#39;</span><span class="p">]</span>
<span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$p$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">]</span>
<span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span><span class="p">]</span>
<span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xlab</span><span class="p">,</span> <span class="n">ylab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xlabels</span><span class="p">,</span> <span class="n">ylabels</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Trajectory_tutorial_24_0.png" src="../_images/tutorial_Trajectory_tutorial_24_0.png" />
</div>
</div>
</section>
<section id="Trajectory-stopping-conditions">
<h3>Trajectory stopping conditions<a class="headerlink" href="#Trajectory-stopping-conditions" title="Link to this heading"></a></h3>
<p>In principle, the inspiral trajectory continues until <span class="math notranslate nohighlight">\(p\)</span> intersects with the separatrix, <span class="math notranslate nohighlight">\(p_\mathrm{sep}(a, e, x_I)\)</span>. However, FEW truncates the inspiral at the buffer point <span class="math notranslate nohighlight">\(p_\mathrm{stop} = p_\mathrm{sep} + \Delta p\)</span> for numerical stability, performing a root-finding operation to place the last trajectory point within <span class="math notranslate nohighlight">\(\sim 10^{-8}\)</span> of <span class="math notranslate nohighlight">\(p_\mathrm{stop}\)</span>.</p>
<p>The size of <span class="math notranslate nohighlight">\(\Delta p\)</span> can vary based on the trajectory model, and can be obtained directly from the ODE object:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">few.utils.utility</span> <span class="kn">import</span> <span class="n">get_separatrix</span>
<span class="n">Delta_p</span> <span class="o">=</span>  <span class="n">KerrEccEqFlux</span><span class="p">()</span><span class="o">.</span><span class="n">separatrix_buffer_dist</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Delta_p:&quot;</span><span class="p">,</span> <span class="n">Delta_p</span><span class="p">)</span>
<span class="n">p_sep</span> <span class="o">=</span> <span class="n">get_separatrix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># the separatrix at the trajectory end-point.</span>
<span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">p_sep</span> <span class="o">+</span> <span class="n">Delta_p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Delta_p: 0.05
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
np.float64(4.97021979128931e-10)
</pre></div></div>
</div>
</section>
<section id="Output-on-a-requested-time-grid">
<h3>Output on a requested time grid<a class="headerlink" href="#Output-on-a-requested-time-grid" title="Link to this heading"></a></h3>
<p>In addition to the sparse output of the adaptive solver, the user can also construct trajectories on pre-defined time grids. For uniform grids, the sampling cadence <span class="math notranslate nohighlight">\(\mathrm{d}t\)</span> can be supplied and the grid will be constructed automatically. Non-uniform grids can be supplied via the <code class="docutils literal notranslate"><span class="pre">new_t</span></code> keyword argument. In either case, the <code class="docutils literal notranslate"><span class="pre">fix_t</span></code> keyword argument can be used to truncate the returned trajectory at its end-point.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">new_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2e7</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

<span class="c1"># a warning will be thrown if the new_t array goes beyond the time array output from the trajectory</span>
<span class="n">t1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">Phi_phi1</span><span class="p">,</span> <span class="n">Phi_theta1</span><span class="p">,</span> <span class="n">Phi_r1</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">new_t</span><span class="o">=</span><span class="n">new_t</span><span class="p">,</span> <span class="n">upsample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># you can cut the excess on these arrays by setting fix_t to True</span>
<span class="n">t2</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">Phi_phi2</span><span class="p">,</span> <span class="n">Phi_theta2</span><span class="p">,</span> <span class="n">Phi_r2</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">new_t</span><span class="o">=</span><span class="n">new_t</span><span class="p">,</span> <span class="n">upsample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fix_t</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">Phi_phi1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">Phi_phi2</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;t1 max:&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s1">&#39;t2 max:&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
t1 max: 19999900.0 t2 max: 17361000.0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Trajectory_tutorial_30_1.png" src="../_images/tutorial_Trajectory_tutorial_30_1.png" />
</div>
</div>
</section>
<section id="Return-trajectory-in-dimensionless-time-coordinates">
<h3>Return trajectory in dimensionless time coordinates<a class="headerlink" href="#Return-trajectory-in-dimensionless-time-coordinates" title="Link to this heading"></a></h3>
<p>Trajectories are returned in coordinate time by default, but may be obtained in dimensionless time units by passing <code class="docutils literal notranslate"><span class="pre">is_coordinate_time=False</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">in_coordinate_time</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\Phi_\phi$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Phi_r</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\Phi_r$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dimensionless time step:&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dimensionless time step: 2.030254435033953
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Trajectory_tutorial_33_1.png" src="../_images/tutorial_Trajectory_tutorial_33_1.png" />
</div>
</div>
</section>
<section id="Integrating-trajectories-with-a-fixed-time-step">
<h3>Integrating trajectories with a fixed time-step<a class="headerlink" href="#Integrating-trajectories-with-a-fixed-time-step" title="Link to this heading"></a></h3>
<p>The adaptive stepping of the solver can be disabled with the <code class="docutils literal notranslate"><span class="pre">DENSE_STEPPING</span></code> keyword argument, which switches to taking uniform steps of size <code class="docutils literal notranslate"><span class="pre">dt</span></code>. This is more expensive and memory-intensive than adaptive stepping.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T_dense</span> <span class="o">=</span> <span class="mf">0.005</span>

<span class="n">t_dense</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T_dense</span><span class="p">,</span> <span class="n">DENSE_STEPPING</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">t_adaptive</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T_dense</span><span class="p">)</span>
<span class="n">t_dense</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">t_adaptive</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
((15780,), (8,))
</pre></div></div>
</div>
<p>We can directly verify the accuracy of the adaptive solution by evaluating its output on the densely-stepped trajectory’s time grid. The phase errors will be larger than the error in the orbital elements by a factor of <span class="math notranslate nohighlight">\(M / mu\)</span> due to conventions chosen during integration:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_dense</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T_dense</span><span class="p">,</span> <span class="n">DENSE_STEPPING</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">t_adaptive</span><span class="p">,</span> <span class="n">p_adaptive</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">Phi_phi_adaptive</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T_dense</span><span class="p">,</span> <span class="n">new_t</span><span class="o">=</span><span class="n">t_dense</span><span class="p">,</span> <span class="n">upsample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">t_dense</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Phi_phi_adaptive</span> <span class="o">-</span> <span class="n">Phi_phi</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Phase error&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">t_dense</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">p_adaptive</span> <span class="o">-</span> <span class="n">p</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;p error&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x1565a2f50&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Trajectory_tutorial_38_1.png" src="../_images/tutorial_Trajectory_tutorial_38_1.png" />
</div>
</div>
</section>
<section id="Evolving-trajectories-backwards-in-time">
<h3>Evolving trajectories backwards in time<a class="headerlink" href="#Evolving-trajectories-backwards-in-time" title="Link to this heading"></a></h3>
<p>Trajectories can also be evolved in reverse via the <code class="docutils literal notranslate"><span class="pre">integrate_backwards</span></code> keyword argument. Trajectories evolved in either direction will agree up to the numerical tolerance of the integrator:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">traj_pars_back</span> <span class="o">=</span> <span class="n">traj_pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">T</span> <span class="o">=</span> <span class="mf">0.55</span>

<span class="c1"># forward</span>
<span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">xI</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>

<span class="n">traj_pars_back</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">traj_pars_back</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">traj_pars_back</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">xI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># backward</span>
<span class="n">t_back</span><span class="p">,</span> <span class="n">p_back</span><span class="p">,</span> <span class="n">e_back</span><span class="p">,</span> <span class="n">xI_back</span><span class="p">,</span> <span class="n">Phi_phi_back</span><span class="p">,</span> <span class="n">Phi_theta_back</span><span class="p">,</span> <span class="n">Phi_r_back</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars_back</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">integrate_backwards</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_back</span><span class="p">,</span> <span class="n">e_back</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">p_back</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
np.float64(6.0975224869253e-11)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Trajectory_tutorial_41_1.png" src="../_images/tutorial_Trajectory_tutorial_41_1.png" />
</div>
</div>
</section>
<section id="Setting-the-integrator-error-tolerance">
<h3>Setting the integrator error tolerance<a class="headerlink" href="#Setting-the-integrator-error-tolerance" title="Link to this heading"></a></h3>
<p>The integrator tolerance (which is an absolute tolerance) can be adjusted by setting the <code class="docutils literal notranslate"><span class="pre">err</span></code> keyword argument. Higher error tolerances reduce the number of points in the trajectory, but at the cost of numerical accuracy. Note that <code class="docutils literal notranslate"><span class="pre">err</span></code> is a <em>local</em> error tolerance, not a global one, and must therefore be set conservatively with respect to the desired global error tolerance. The default setting of <span class="math notranslate nohighlight">\(10^{-11}\)</span> is a reasonable value and should not need to be changed for typical
scenarios.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">p_hightol</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="o">*</span><span class="n">traj_pars</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">p_hightol</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p_hightol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(63, 38, -1.3032154626557713e-06)
</pre></div></div>
</div>
</section>
<section id="Integrating-trajectories-in-(E,-L,-Q)-coordinates">
<h3>Integrating trajectories in <span class="math notranslate nohighlight">\((E, L, Q)\)</span> coordinates<a class="headerlink" href="#Integrating-trajectories-in-(E,-L,-Q)-coordinates" title="Link to this heading"></a></h3>
<p>Trajectories can also be solved in the constants of motion parameterisation <span class="math notranslate nohighlight">\((E, L, Q)\)</span>. This is supported for all stock trajectory models. Given input <span class="math notranslate nohighlight">\((p_0, e_0, x_{I,0})\)</span>, the integrator converts these initial conditions to <span class="math notranslate nohighlight">\((E, L, Q)\)</span> and integrates these quantities alongside the inspiral phases. The output trajectory is converted back to <span class="math notranslate nohighlight">\((p, e, x_I)\)</span> coordinates if the keyword argument <code class="docutils literal notranslate"><span class="pre">convert_pex=True</span></code> (which it is by default).</p>
<p>Integrating in <span class="math notranslate nohighlight">\((E, L, Q)\)</span> can offer some advantages, especially near the separatrix (see <a class="reference external" href="https://arxiv.org/abs/2401.09577">Hughes 2024</a> for more information). Typically the trajectory also consists of fewer points than its <span class="math notranslate nohighlight">\((p, e, x_I)\)</span> counterpart, and is therefore faster to compute. However, it can also be numerically unstable for very small eccentricities, where small errors in the constants of motion can be amplified when transformed back to <span class="math notranslate nohighlight">\((p, e, x_I)\)</span>. Usage of
this method should be considered somewhat experimental, especially for eccentric and inclined (generic) inspirals.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="mf">1e6</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">1e2</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">p0</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="n">e0</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">xI0</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">T</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">traj_model_ELQ</span> <span class="o">=</span> <span class="n">EMRIInspiral</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">SchwarzEccFlux</span><span class="p">,</span> <span class="n">integrate_constants_of_motion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">traj_model_pex</span> <span class="o">=</span> <span class="n">EMRIInspiral</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">SchwarzEccFlux</span><span class="p">,</span> <span class="n">integrate_constants_of_motion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$e$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$p$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$e$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\Phi_\phi$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\Phi_\theta$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\Phi_r$&#39;</span><span class="p">]</span>
<span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$p$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">]</span>

<span class="n">lens</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">phase_ends</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">traj_model</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">traj_model_ELQ</span><span class="p">,</span> <span class="n">traj_model_pex</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;ELQ&#39;</span><span class="p">,</span> <span class="s1">&#39;pex&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">]):</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">xI</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span> <span class="o">=</span> <span class="n">traj_model</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">xI0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Plot the results for comparison</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">Phi_phi</span><span class="p">,</span> <span class="n">Phi_theta</span><span class="p">,</span> <span class="n">Phi_r</span><span class="p">]</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xlab</span><span class="p">,</span> <span class="n">ylab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xlabels</span><span class="p">,</span> <span class="n">ylabels</span><span class="p">)):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">lens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="n">phase_ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Phi_phi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(ELQ, pex) trajectory lengths:&quot;</span><span class="p">,</span> <span class="n">lens</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(ELQ, pex) phase difference:&quot;</span><span class="p">,</span> <span class="n">phase_ends</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">phase_ends</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Trajectory_tutorial_47_0.png" src="../_images/tutorial_Trajectory_tutorial_47_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(ELQ, pex) trajectory lengths: [36, 48]
(ELQ, pex) phase difference: 0.0005533642797672655
</pre></div></div>
</div>
</section>
</section>
<section id="User-defined-trajectory-models">
<h2>User-defined trajectory models<a class="headerlink" href="#User-defined-trajectory-models" title="Link to this heading"></a></h2>
<p>In addition to FEW’s built-in trajectory models, users can readily implement their own models in the same framework. They can achieve this by:</p>
<ul class="simple">
<li><p>Subclassing the <code class="docutils literal notranslate"><span class="pre">ODEBase</span></code> base class,</p></li>
<li><p>Defining the <code class="docutils literal notranslate"><span class="pre">evaluate_rhs</span></code> method, and</p></li>
<li><p>Updating any relevant properties of the model (by default, they are set for generic Kerr inspirals).</p></li>
</ul>
<p>Let’s implement a Post-Newtonian trajectory in Schwarzschild eccentric as an example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Some elliptic functions for evaluating geodesic frequencies</span>
<span class="kn">from</span> <span class="nn">few.utils.elliptic</span> <span class="kn">import</span> <span class="n">EllipK</span><span class="p">,</span> <span class="n">EllipE</span><span class="p">,</span> <span class="n">EllipPi</span>

<span class="c1"># base classes</span>
<span class="kn">from</span> <span class="nn">few.trajectory.ode.base</span> <span class="kn">import</span> <span class="n">ODEBase</span>

<span class="c1"># for common interface with C/mathematica</span>
<span class="k">def</span> <span class="nf">Power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="n">n</span>

<span class="k">def</span> <span class="nf">Sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># this class defines the right-hand side of the ODE</span>
<span class="c1"># we define the method &quot;evaluate_rhs&quot; according to our derivatives</span>
<span class="c1"># we set the &quot;equatorial&quot; and &quot;background&quot; properties accordingly</span>
<span class="k">class</span> <span class="nc">Schwarzschild_PN</span><span class="p">(</span><span class="n">ODEBase</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">equatorial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">background</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Schwarzschild&quot;</span>

    <span class="k">def</span> <span class="nf">evaluate_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># guard against bad integration steps</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">xI</span><span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

        <span class="c1"># perform elliptic calculations</span>
        <span class="n">ellipE</span> <span class="o">=</span> <span class="n">EllipE</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">e</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mf">6.0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">e</span><span class="p">))</span>
        <span class="n">ellipK</span> <span class="o">=</span> <span class="n">EllipK</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">e</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mf">6.0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">e</span><span class="p">))</span>
        <span class="n">ellipPi1</span> <span class="o">=</span> <span class="n">EllipPi</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">e</span><span class="o">/</span><span class="p">(</span><span class="mf">12.0</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">e</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="n">e</span> <span class="o">-</span> <span class="mi">8</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="mi">4</span><span class="o">*</span><span class="n">e</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mf">6.0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">e</span><span class="p">))</span>
        <span class="n">ellipPi2</span> <span class="o">=</span> <span class="n">EllipPi</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.0</span><span class="o">+</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mf">6.0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">e</span><span class="p">)),</span> <span class="mi">4</span><span class="o">*</span><span class="n">e</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mf">6.0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">e</span><span class="p">))</span>

        <span class="c1"># Azimuthal frequency</span>
        <span class="n">Omega_phi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mf">1.5</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">Sqrt</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="p">((</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">ellipPi2</span><span class="o">*</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">ellipE</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">+</span> <span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span>
              <span class="p">(</span><span class="n">ellipK</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">28</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">12</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">ellipK</span> <span class="o">+</span> <span class="n">ellipPi2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">+</span> <span class="n">p</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ellipK</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ellipPi1</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">+</span> <span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">-</span> <span class="n">p</span><span class="p">)))</span><span class="o">/</span>
            <span class="p">(</span><span class="n">ellipK</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))))</span>

        <span class="c1"># Post-Newtonian calculations</span>
        <span class="n">yPN</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">Omega_phi</span><span class="p">,</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>

        <span class="n">EdotPN</span> <span class="o">=</span> <span class="p">(</span><span class="mi">96</span> <span class="o">+</span> <span class="mi">292</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">37</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">15.</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mf">3.5</span><span class="p">))</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">yPN</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">LdotPN</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="mf">5.</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">yPN</span><span class="p">,</span> <span class="mf">7.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>

        <span class="c1"># flux</span>
        <span class="n">Edot</span> <span class="o">=</span> <span class="o">-</span><span class="n">EdotPN</span>
        <span class="n">Ldot</span> <span class="o">=</span> <span class="o">-</span><span class="n">LdotPN</span>

        <span class="c1"># time derivatives</span>
        <span class="n">pdot</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Edot</span><span class="o">*</span><span class="n">Sqrt</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ldot</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Sqrt</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">-</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">edot</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">Edot</span><span class="o">*</span><span class="n">Sqrt</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mf">1.5</span><span class="p">)</span><span class="o">*</span>
        <span class="p">(</span><span class="mi">18</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">9</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">Ldot</span><span class="o">*</span><span class="n">Sqrt</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">-</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span>
        <span class="p">(</span><span class="n">e</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>

        <span class="n">xIdot</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">Phi_phi_dot</span> <span class="o">=</span> <span class="n">Omega_phi</span>
        <span class="n">Phi_theta_dot</span> <span class="o">=</span> <span class="n">Omega_phi</span>

        <span class="n">Phi_r_dot</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">Sqrt</span><span class="p">((</span><span class="o">-</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">ellipK</span> <span class="o">+</span> <span class="p">((</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">ellipPi2</span><span class="o">*</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">ellipE</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">+</span> <span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span>
        <span class="p">(</span><span class="n">ellipK</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">28</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">12</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Power</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">ellipK</span> <span class="o">+</span> <span class="n">ellipPi2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">+</span> <span class="n">p</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ellipK</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ellipPi1</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">+</span> <span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">-</span> <span class="n">p</span><span class="p">)))</span><span class="o">/</span><span class="n">Power</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">dydt</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdot</span><span class="p">,</span> <span class="n">edot</span><span class="p">,</span> <span class="n">xIdot</span><span class="p">,</span> <span class="n">Phi_phi_dot</span><span class="p">,</span> <span class="n">Phi_theta_dot</span><span class="p">,</span> <span class="n">Phi_r_dot</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dydt</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="mf">1e6</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">1e2</span>
<span class="n">p0</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="n">e0</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">T</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">traj</span> <span class="o">=</span> <span class="n">EMRIInspiral</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">Schwarzschild_PN</span><span class="p">)</span>

<span class="n">test</span> <span class="o">=</span> <span class="n">traj</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">traj2</span> <span class="o">=</span> <span class="n">EMRIInspiral</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">SchwarzEccFlux</span><span class="p">)</span>

<span class="n">flux</span> <span class="o">=</span> <span class="n">traj2</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pn&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x169592550&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Trajectory_tutorial_51_1.png" src="../_images/tutorial_Trajectory_tutorial_51_1.png" />
</div>
</div>
<section id="Modifying-an-existing-trajectory-model">
<h3>Modifying an existing trajectory model<a class="headerlink" href="#Modifying-an-existing-trajectory-model" title="Link to this heading"></a></h3>
<p>In cases where the desired trajectory model can be expressed as a function of one that is supported out-of-the-box, the inbuilt model can be subclassed and supplemented as required by defining the <code class="docutils literal notranslate"><span class="pre">modify_rhs</span></code> method. This method does not support a return argument for efficiency; the content of the first argument <code class="docutils literal notranslate"><span class="pre">derivs</span></code> should be modified in-place.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">few.trajectory.ode.flux</span> <span class="kn">import</span> <span class="n">KerrEccEqFlux</span>

<span class="k">class</span> <span class="nc">ModifiedKerrEccEqFlux</span><span class="p">(</span><span class="n">KerrEccEqFlux</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">modify_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ydot</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1">#in-place modification of the derivatives</span>
        <span class="n">ydot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ydot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">M</span> <span class="o">=</span> <span class="mf">1e6</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">1e2</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">e</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">x</span> <span class="o">=</span> <span class="mf">1.</span>

<span class="n">additional_args</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">]</span>

<span class="c1"># Example usage</span>
<span class="n">modified_ode</span> <span class="o">=</span> <span class="n">ModifiedKerrEccEqFlux</span><span class="p">()</span>
<span class="n">modified_ode</span><span class="o">.</span><span class="n">add_fixed_parameters</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">additional_args</span><span class="p">)</span>

<span class="n">modified_ode</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([-0.01162928, -0.00058962,  0.        ,  0.02761918,  0.02656476,
        0.02068311])
</pre></div></div>
</div>
</section>
<section id="Passing-additional-arguments-to-a-modified-trajectory-model">
<h3>Passing additional arguments to a modified trajectory model<a class="headerlink" href="#Passing-additional-arguments-to-a-modified-trajectory-model" title="Link to this heading"></a></h3>
<p>When calling a trajectory, the <code class="docutils literal notranslate"><span class="pre">additional_args</span></code> attribute of the ODE class will be populated with any positional arguments following <span class="math notranslate nohighlight">\(x_I\)</span>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">traj</span> <span class="o">=</span> <span class="n">EMRIInspiral</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">ModifiedKerrEccEqFlux</span><span class="p">)</span>

<span class="n">test</span> <span class="o">=</span> <span class="n">traj</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">traj2</span> <span class="o">=</span> <span class="n">EMRIInspiral</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">KerrEccEqFlux</span><span class="p">)</span>

<span class="n">flux</span> <span class="o">=</span> <span class="n">traj2</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">test</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;flux + mod&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x1695d1450&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Trajectory_tutorial_57_1.png" src="../_images/tutorial_Trajectory_tutorial_57_1.png" />
</div>
</div>
<p>User-defined trajectories can be readily implemented in waveform models in the FEW framework - see TODO.</p>
</section>
</section>
<section id="Trajectory-related-utilities">
<h2>Trajectory-related utilities<a class="headerlink" href="#Trajectory-related-utilities" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">few.utils.utility</span> <span class="kn">import</span> <span class="n">get_p_at_t</span><span class="p">,</span> <span class="n">get_mu_at_t</span>
</pre></div>
</div>
</div>
<section id="Get-p_0-based-on-desired-duration-of-trajectory">
<h3>Get <span class="math notranslate nohighlight">\(p_0\)</span> based on desired duration of trajectory<a class="headerlink" href="#Get-p_0-based-on-desired-duration-of-trajectory" title="Link to this heading"></a></h3>
<p>If you have a desired length of trajectory to analyze, this function will give you the value of <span class="math notranslate nohighlight">\(p_0\)</span> that corresponds to the proper evolution time.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">traj_module</span> <span class="o">=</span> <span class="n">EMRIInspiral</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">SchwarzEccFlux</span><span class="p">)</span>

<span class="c1"># set initial parameters</span>
<span class="n">M</span> <span class="o">=</span> <span class="mf">1e6</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">5e1</span>
<span class="n">e0</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="n">traj_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">traj_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">index_of_p</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">t_out</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="c1"># run trajectory</span>
<span class="n">p_new</span> <span class="o">=</span> <span class="n">get_p_at_t</span><span class="p">(</span>
    <span class="n">traj_module</span><span class="p">,</span>
    <span class="n">t_out</span><span class="p">,</span>
    <span class="n">traj_args</span><span class="p">,</span>
    <span class="n">index_of_p</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">index_of_a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">index_of_e</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">index_of_x</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">traj_kwargs</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">xtol</span><span class="o">=</span><span class="mf">2e-12</span><span class="p">,</span>
    <span class="n">rtol</span><span class="o">=</span><span class="mf">8.881784197001252e-16</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p0 = </span><span class="si">{}</span><span class="s1"> will create a waveform that is </span><span class="si">{}</span><span class="s1"> years long, given the other input parameters.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_new</span><span class="p">,</span> <span class="n">t_out</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
p0 = 13.059789979167254 will create a waveform that is 1.5 years long, given the other input parameters.
</pre></div></div>
</div>
</section>
<section id="Get-\mu-based-on-desired-duration-of-trajectory">
<h3>Get <span class="math notranslate nohighlight">\(\mu\)</span> based on desired duration of trajectory<a class="headerlink" href="#Get-\mu-based-on-desired-duration-of-trajectory" title="Link to this heading"></a></h3>
<p>If you have a desired length of trajectory to analyze, this function will give you the value of <span class="math notranslate nohighlight">\(\mu\)</span> that corresponds to the proper evolution time.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">traj_module</span> <span class="o">=</span> <span class="n">EMRIInspiral</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">SchwarzEccFlux</span><span class="p">)</span>

<span class="c1"># set initial parameters</span>
<span class="n">M</span> <span class="o">=</span> <span class="mf">1e6</span>
<span class="n">p0</span> <span class="o">=</span> <span class="mf">11.0</span>
<span class="n">e0</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="n">traj_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="n">traj_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">index_of_mu</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">t_out</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="c1"># run trajectory</span>
<span class="n">mu_new</span> <span class="o">=</span> <span class="n">get_mu_at_t</span><span class="p">(</span>
    <span class="n">traj_module</span><span class="p">,</span>
    <span class="n">t_out</span><span class="p">,</span>
    <span class="n">traj_args</span><span class="p">,</span>
    <span class="n">index_of_mu</span><span class="o">=</span><span class="n">index_of_mu</span><span class="p">,</span>
    <span class="n">traj_kwargs</span><span class="o">=</span><span class="n">traj_kwargs</span><span class="p">,</span>
    <span class="n">xtol</span><span class="o">=</span><span class="mf">2e-12</span><span class="p">,</span>
    <span class="n">rtol</span><span class="o">=</span><span class="mf">8.881784197001252e-16</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mu = </span><span class="si">{}</span><span class="s1"> will create a waveform that is </span><span class="si">{}</span><span class="s1"> years long, given the other input parameters.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mu_new</span><span class="p">,</span> <span class="n">t_out</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
mu = 18.804307108664766 will create a waveform that is 1.5 years long, given the other input parameters.
</pre></div></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../user/cite.html" class="btn btn-neutral float-left" title="Citations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="FastEMRIWaveforms_tutorial.html" class="btn btn-neutral float-right" title="Fast and Accurate EMRI Waveforms Tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Michael Katz, Alvin Chua, Niels Warburton.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>